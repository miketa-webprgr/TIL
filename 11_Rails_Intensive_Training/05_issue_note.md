# Issue05 æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã„ã„ã­æ©Ÿèƒ½ã‚’å®Ÿè£…

## ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ

<a href="https://gyazo.com/d5eca6e3b281897fb3086a973d48cfb3"><img src="https://i.gyazo.com/d5eca6e3b281897fb3086a973d48cfb3.gif" alt="Image from Gyazo" width="500" border=1/></a><br>  

<a href="https://gyazo.com/ee0c03fa2d4b4ed8bfe8f901262bb492"><img src="https://i.gyazo.com/ee0c03fa2d4b4ed8bfe8f901262bb492.gif" alt="Image from Gyazo" width="500" border=1/></a><br>  

## æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½å®Ÿè£…ãƒ»å®Ÿè£…æ¡ä»¶ã«ã¤ã„ã¦ã«ã¤ã„ã¦

1. æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã„ã„ã­æ©Ÿèƒ½ã‚’å®Ÿè£…
2. link_toã‚’ä½¿ã£ã¦éåŒæœŸå‡¦ç†ã¨ã—ã¦å®Ÿè£…ã™ã‚‹
3. like, unlike, like?ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã«å®Ÿè£…ã—ã¦ãã‚Œã‚’åˆ©ç”¨ã™ã‚‹å½¢ã«ã™ã‚‹
4. Likeãƒ¢ãƒ‡ãƒ«ã«é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹

## åˆ†ã‹ã‚‰ãªã„å˜èªãƒ»æ¦‚å¿µç­‰ã®ä¸€è¦§

### å¤šå¯¾å¤šã®assocationã«ã¤ã„ã¦

ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’ç†Ÿèª­ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ãŸã€‚  

- [ã€åˆå¿ƒè€…å‘ã‘ã€‘ä¸å¯§ã™ãã‚‹Railsã€ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€å¹¾ã‚‰ä½•ã§ã‚‚ã€‘ã€å®Œç’§ã«ã‚ã‹ã‚‹ã€‘ğŸ¸ \- Qiita](https://qiita.com/kazukimatsumoto/items/14bdff681ec5ddac26d1#user%E3%81%A8user%E3%81%AE%E5%A4%9A%E5%AF%BE%E5%A4%9Amn%E3%82%92%E8%A8%AD%E8%A8%88%E3%81%97%E3%82%88%E3%81%86%E8%87%AA%E5%B7%B1%E7%B5%90%E5%90%88)

å¤šå¯¾å¤šã®é–¢ä¿‚ã¯ã€ä»Šå›ã®ã‚ˆã†ãªã„ã„ã­æ©Ÿèƒ½ã‚’è€ƒãˆã¦ã¿ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚  

æŠ•ç¨¿ã¯ã€ãŸãã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã„ã„ã­ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚  
Post has many users ã¨æ‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  

ä»–æ–¹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¤šãã®æŠ•ç¨¿ã‚’ã„ã„ã­ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  
User has many posts ã¨æ‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  

ã“ã®é–¢ä¿‚ã¯ã€ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã‚‹ã€‚  
è©³ã—ãã¯Qiitaè¨˜äº‹ã®ã¨ãŠã‚Šã ãŒã€ã„ã„ã­ï¼ˆLike)ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ãŒè¨­ã‘ã‚‰ã‚Œã‚‹ã€‚  

- id
- user_id
- post_id

`user_id: 1`ãŒ`post_id: 9`ã‚’ã„ã„ã­ã™ã‚Œã°ã€ãã®é–¢ä¿‚è‡ªä½“ã«`id: 1`ãŒä»˜ä¸ã•ã‚Œã€  
Likeãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚é€†ã‚‚ç„¶ã‚Šã§ã€`post_id :9`ãŒ`user_id: 2`ã«ã„ã„ã­ã•ã‚Œã‚Œã°ã€  
åŒæ§˜ã«ãã®é–¢ä¿‚è‡ªä½“ã«`id: 2`ãŒä»˜ä¸ã•ã‚Œã€Likeãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚  

## å…·ä½“çš„ãªå®Ÿè£…æ‰‹é †ã«ã¤ã„ã¦

ã„ã„ã­æ©Ÿèƒ½å®Ÿè£…ã«ã‚ãŸã£ã¦ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚  

1. Likeãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã¨associationã®è¨­å®š
2. Likeãƒ¢ãƒ‡ãƒ«ã«é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹
3. like, unlike, like?ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½œæˆï¼ˆUserãƒ¢ãƒ‡ãƒ«ã§ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ï¼‰
4. viewã®å®Ÿè£…
5. Create + Destroy æ©Ÿèƒ½ï¼ˆéåŒæœŸï¼‰å®Ÿè£…ã®ãŸã‚ã®`js.slim`ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

### 1. Likeãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã¨associationã®è¨­å®š

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ã¦Likeãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

```rb
rails g model like user:references post:references
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚  

```rb:like.rb
# like.rb
class Like < ApplicationRecord
  belongs_to :user
  belongs_to :post
end
```

```rb:migration.rb
# 20200720140202_create_likes.rb
class CreateLikes < ActiveRecord::Migration[5.2]
  def change
    create_table :likes do |t|
      t.references :user, foreign_key: true
      t.references :post, foreign_key: true

      t.timestamps
      # ã“ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã«ã¤ã„ã¦ã¯ã€æ‰‹å‹•ã§è¿½è¨˜
      # ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ã„ã„ã­ãŒ2å›ã§ããªã„ã‚ˆã†ã«ãªã‚‹
      t.index [:user_id, :post_id], unique: true
    end
  end
end
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€`rails db:migrate`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚  

Likeãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ã€å¤–éƒ¨ã‚­ãƒ¼ã‚’ï¼’ã¤æŒ‡å®šã™ã‚‹å½¢ã¨ãªã‚‹ã®ã§ã€  
`belongs_to :user`ã¨`belongs_to :post`ã¨æ›¸ãã€‚

ã¾ãŸã€Userãƒ¢ãƒ‡ãƒ«ã¨Postãƒ¢ãƒ‡ãƒ«ã§`has_many :likes`ã¨æ›¸ãã€‚  

ã„ã„ã­ã—ãŸpostã‚’å–å¾—ã™ã‚‹å ´åˆã€ãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã—ã¦ãŠãã¨ç°¡å˜ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  
å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã€‚  

```rb:user.rb
# user.rb
class User < ApplicationRecord
  has_many :posts
  has_many :likes
  # like_postsã¨ã„ã†ç‹¬è‡ªã‚«ãƒ©ãƒ ï¼Ÿã‚’è¨­ã‘ã‚‹ã€‚user.likesã¨ã™ã‚‹ã“ã¨ã§ã€ã„ã„ã­ã—ãŸæŠ•ç¨¿ã‚’å–å¾—ã§ãã‚‹ã€‚
  has_many :like_posts, through: :likes, source: :post
end
```

Postãƒ¢ãƒ‡ãƒ«ã§ã‚‚åŒæ§˜ã®è¨˜è¿°ã‚’ã™ã‚‹ã€‚  
ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®æŠ•ç¨¿ã‚’ã„ã„ã­ã—ãŸuserã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå®¹æ˜“ã«ãªã‚‹ã€‚  

```rb:post.rb
# post.rb
class Post < ApplicationRecord
  belongs_to :user
  has_many :comments, dependent: :destroy
  has_many :likes, dependent: :destroy
  has_many :like_users, through: :likes, source: :user
  # ãã®ä»–ã«æ›¸ã„ãŸè¨­å®šã«ã¤ã„ã¦ã¯çœç•¥ã€‚ã“ã“ã§ã¯associationé–¢é€£ã®è¨˜è¿°ã®ã¿æ²è¼‰ã€‚
end
```

### 2. Likeãƒ¢ãƒ‡ãƒ«ã«é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹

æ—¢ã«è¨­å®šæ¸ˆã ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ã‹ã‘ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€  
åŒã˜user_idã¨post_idã®çµ„ã¿åˆã‚ã›ã¯ä¿å­˜ã§ããªã„ã‚ˆã†ã«ãªã£ãŸã€‚  
ã“ã®ã“ã¨ã«ã‚ˆã‚Šã€ã„ã„ã­ãŒï¼’å›ã§ããªã„ã‚ˆã†ã«ãªã£ãŸã€‚  

åˆã‚ã›ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã ã‘ã§ãªãã€ãƒ¢ãƒ‡ãƒ«ã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ãã®éš›ã«ã¯ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚ç…§ã™ã‚‹ã¨ã‚ˆã„ã€‚  
- [Railsã§2ã¤ä»¥ä¸Šã®å€¤ã®çµ„ã¿åˆã‚ã›ã«å¯¾ã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ã‹ã‘ã‚‹ \- Qiita](https://qiita.com/wadako111/items/958dded40a840c35c5ec)  

å…·ä½“çš„ã«ã¯ã€Likeãƒ¢ãƒ‡ãƒ«ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã€‚  

```rb:like.rb
# like.rb
class Like < ApplicationRecord
  belongs_to :user
  belongs_to :post

  validates :user_id, uniqueness: { scope: :post_id }
end
```

### 3. like, unlike, like?ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½œæˆï¼ˆUserãƒ¢ãƒ‡ãƒ«ã§ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ï¼‰

å¯èª­æ€§ã‚’å‘ä¸Šã—ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ“ãƒ¥ãƒ¼ã«æ›¸ã‹ãªã„ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹ã¨ã‚ˆã„ã€‚  

- æŠ•ç¨¿ã‚’ã„ã„ã­ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
- æŠ•ç¨¿ã®ã„ã„ã­ã‚’è§£é™¤ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
- æŠ•ç¨¿ã‚’ã„ã„ã­ã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã®ã‚³ãƒ¼ãƒ‰ã¨ãªã‚‹ã€‚  

```rb
# user.rbã«ä»¥ä¸‹ã‚’è¨˜è¼‰
def like(post)
  like_posts << post
end

def unlike(post)
  like_posts.destroy(post)
end

def like?(post)
  like_posts.include?(post)
end
```

### 4. viewã®å®Ÿè£…

ã„ã„ã­æ©Ÿèƒ½ã¯ã€æŠ•ç¨¿ã®ä¸€è¦§ç”»é¢(`index.html.slim`ï¼‰ã¨æŠ•ç¨¿ã®è©³ç´°ç”»é¢ï¼ˆ`show.html.slim`ï¼‰ã§å®Ÿè£…ã•ã‚Œã‚‹ã€‚  

`index.html.slim`ã«ãŠã‘ã‚‹æŠ•ç¨¿ã®ç”»é¢ã¯ã€`_post.html.slim`ã®ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«ã«ã‚ˆã£ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€‚  
ãã¡ã‚‰ã‚’å‚ç…§ã—ã€ã©ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¨ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚  

### `_post.html.slim`

ã„ã„ã­æ©Ÿèƒ½ã«è©²å½“ã™ã‚‹éƒ¨åˆ†ã®æ§‹æˆã¯ã€ä¸‹è¨˜ã®ã¨ãŠã‚Šã¨ãªã£ã¦ã„ã‚‹ã€‚  

<img src="05_issue_note_like-img01.png" width=500px border=1><br>  

ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã‚ã‚‹ã€‚  

```_post.html.slim
.card.mb-5.post
  .card-header
    .d-flex.align-items-center
      = image_tag 'profile-placeholder.png', size: '40x40', class: 'rounded-circle mr-1'
      = post.user.username
      - if current_user&.own?(post)
        .ml-auto
          = link_to post_path(post), class: 'mr-3', method: :delete, data: { confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' } do
            = icon 'far', 'trash-alt', class: 'fa-lg'
          = link_to edit_post_path(post) do
            = icon 'far', 'edit', class: 'fa-lg'
      - if current_user && !current_user.own?(post)
        .ml-auto
          /ã“ã“ã§ã„ã„ã­æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã‚‹
          = render 'like_area', post: post
ã€œçœç•¥ã€œ
```

### `_like_area.html.slim`

ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã¨ãªã£ã¦ã„ã‚‹ã€‚  

```_like_area.html.slim
/ _like_area.html.slim
div id="like_area-#{post.id}"
  - if current_user.like?(post)
    = render 'unlike', post: post
  - else
    = render 'like', post: post
```

`like?`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã„ã„ã­ã—ãŸæŠ•ç¨¿ã§ã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹ã€‚  

æŠ•ç¨¿ã‚’ã„ã„ã­ã—ã¦ã„ã‚Œã°ã€`unlike`ã‚’renderã™ã‚‹ã€‚  
æŠ•ç¨¿ã‚’ã„ã„ã­ã—ã¦ã„ãªã‘ã‚Œã°ã€`like`ã‚’renderã™ã‚‹ã€‚  

### _unlike.html.slim`ã¨`_like.html.slim`

`_unlike.html.slim`ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã¨ãªã£ã¦ã„ã‚‹ã€‚  
current_userãŒæŒã¤likeã®ä¸­ã‹ã‚‰ã€è©²å½“ã®æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã‚‚ã®ã‚’å‰Šé™¤ã™ã‚‹ã€‚  

ã“ã®å ´åˆã€ã„ã„ã­ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã®ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€  
`icon 'fa', 'heart'`ã¨ã„ã†è‰²ãŒå¡—ã‚‰ã‚ŒãŸçŠ¶æ…‹ã®ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã€‚  

ã¾ãŸã€`/likes/:id(.:format)`ã¨ã„ã†URIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€  
likesã®`id`ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ä¸‹è¨˜ã®ã¨ãŠã‚Š`current_user.likes.find_by`ã¨ã™ã‚‹ã€‚  

```slim:_unlike.html.slim
/ _unlike.html.slim
= link_to like_path(current_user.likes.find_by(post_id: post.id)), method: :delete, remote: true do
  = icon 'fa', 'heart', class: 'fa-lg'
```

`_like.html.slim`ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã¨ãªã£ã¦ã„ã‚‹ã€‚  
ã“ã“ã§ã¯ã€è©²å½“ã®æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã„ã„ã­ã‚’ä½œæˆã™ã‚‹ã€‚  

ã“ã®å ´åˆã€ã„ã„ã­ã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã®ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€  
`icon 'far', 'heart'`ã¨ã„ã†è‰²ãŒå¡—ã‚‰ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã®ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã€‚  

```_like.html.slim
/ _like.html.slim
= link_to likes_path(post_id: post.id), method: :post, remote: true do
  = icon 'far', 'heart', class: 'fa-lg'
```

### `show.html.slim`

ç¶šã„ã¦ã€`show.html.slim`ã®å®Ÿè£…ã‚’è¡Œã†ã€‚  

<img src="05_issue_note_like-img02.png" width=500px border=1><br>  

ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ãŒã€ä¸‹è¨˜ã®ã¨ãŠã‚Šã¨ãªã£ã¦ã„ã‚‹ã€‚  

```slim:show.html.slim
/ show.html.slim
.post-detail.card
  .image-box
    .swiper-container
      .swiper-wrapper
        - @post.images.each do |image|
          .swiper-slide
            = image_tag image.url
      .swiper-pagination
  .image-info-box
    .profile-box.p-3
      .d-flex.align-items-center
        = image_tag 'profile-placeholder.png', size: '40x40', class: 'rounded-circle mr-1'
        = @post.user.username
        - if current_user&.own?(@post)
          .ml-auto
            = link_to post_path(@post), class: 'mr-3', method: :delete, data: {confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'} do
              = icon 'far', 'trash-alt', class: 'fa-lg'
            = link_to edit_post_path(@post) do
              = icon 'far', 'edit', class: 'fa-lg'
        - if current_user && !current_user.own?(@post)
          .ml-auto
            /ã“ã“ã§ã„ã„ã­æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã‚‹
            = render 'like_area', post: @post
    hr.m-0
ã€œçœç•¥ã€œ
```

ãªãŠã€`like_area`ã«ã¤ã„ã¦ã¯æ—¢ã«å–ã‚Šæ‰±ã£ãŸã¨ãŠã‚Šãªã®ã§å‰²æ„›ã™ã‚‹ã€‚  

ã“ã®ã‚ˆã†ã«`index`ã¨`show`ã®ï¼’ç®‡æ‰€ã§ã„ã„ã­æ©Ÿèƒ½ã¯å®Ÿè£…ã®å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€  
ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«åŒ–ã™ã‚‹ã¨éƒ½åˆã‚ˆãå…±é€šåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  

### 5. Createãƒ»Destroyæ©Ÿèƒ½ï¼ˆéåŒæœŸï¼‰å®Ÿè£…ã®ãŸã‚ã®`js.slim`ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

ã¾ãšã€`routes.rb`ã®è¨­å®šã‚’è¡Œã†ã€‚  

```rb:routes.rb
# routes.rb(è©²å½“éƒ¨åˆ†ã®ã¿)
resources: :likes, only: %i[create destroy]
```

æ¬¡ã«ã€ã„ã„ã­æ©Ÿèƒ½å®Ÿè£…ã®ãŸã‚ã€`create.js.slim`ã‚’ä½œæˆã™ã‚‹ã€‚  
ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šã€ã„ã„ã­ã•ã‚Œã¦ã„ãªã„ãƒãƒ¼ãƒˆã‚’ã„ã„ã­ã®ãƒãƒ¼ãƒˆã«å·®ã—æ›¿ãˆã‚‹æ“ä½œã‚’è¨˜è¿°ã™ã‚‹ã€‚  

```slim: js.slim
/ create.js.slim
| $('#like_area-#{@post.id}').html("#{j render('posts/unlike', post: @post)}")
```

ãªãŠã€ä»¥å‰ã®Issueã§æ‰±ã£ãŸã¨ãŠã‚Šã€`j`ã¯`javascript escape`ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹ã€‚  
ã—ã‹ã‚‚ã€JSã§ã¯ãªãã€Railsã®ãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§æ³¨æ„ã™ã‚‹ã“ã¨ã€‚  

ã„ã„ã­è§£é™¤æ©Ÿèƒ½ã®ãŸã‚ã€`destroy.js.slim`ã‚’ä½œæˆã™ã‚‹ã€‚  
ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šã€é€†ã«ã„ã„ã­ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚’ã„ã„ã­å‰ã®ãƒãƒ¼ãƒˆã«å·®ã—æ›¿ãˆã‚‹æ“ä½œã‚’è¨˜è¿°ã™ã‚‹ã€‚  

```slim: js.slim
/ destroy.js.slim
| $('#like_area-#{@post.id}').html("#{j render('posts/like', post: @post)}")
```

ã¾ãŸã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®å®Ÿè£…ã‚‚è¡Œã†ã€‚
`likes_controller.rb`ã«ãŠã„ã¦ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã™ã‚‹ã€‚  

```rb:likes_controller.rb
# likes_controller.rb
class LikesController < ApplicationController
  before_action :require_login, only: %i[create destroy]

  def create
    # params => {"post_id"=>"19", "controller"=>"likes", "action"=>"create"}
    @post = Post.find(params[:post_id])
    current_user.like(@post)
  end

  def destroy
    # params => {"controller"=>"likes", "action"=>"destroy", "id"=>"25"}
    @post = Like.find(params[:id]).post
    current_user.unlike(@post)
  end
end
```

createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã¯ã€è©²å½“ã®æŠ•ç¨¿ã‚’`@post`ã«æ ¼ç´ã—ã€  
current_userãŒæ‰€æœ‰ã™ã‚‹like_postsã«`@post`ã‚’è¿½åŠ ã™ã‚‹ã€‚  

é€†ã«destroyã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã¯ã€Œã„ã„ã­ã€ã—ãŸè©²å½“ã®æŠ•ç¨¿ã‚’`@post`ã«æ ¼ç´ã—ã€  
current_userãŒæ‰€æœ‰ã™ã‚‹like_postsã‹ã‚‰`@post`ã‚’å‰Šé™¤ã™ã‚‹ã€‚  

ãªãŠã€destroyã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦`@post`ã«æ ¼ç´ã™ã‚‹ã‚‚ã®ãŒã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã«  
`Post.find(params[:post_id])`ã«ã—ã¦ã—ã¾ãˆã‚‹ã‚ˆã†ã«æ€ãˆã‚‹ãŒã€ã“ã®ã‚ˆã†ãªæ›¸ãæ–¹ã¯ãƒ€ãƒ¡ãªã®ã‹ã€‚  
ï¼ˆURLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«post_idã‚’è¿½åŠ ã—ã¦ã—ã¾ã†æ–¹æ³•ï¼‰  

çµå±€ã€likeã®`id`ã¯è©²å½“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã§ã—ã‹ãªã„ã®ã§ã€  
å€‹äººçš„ã«@postã®å½¢ãŒå¤‰ã‚ã‚‹ã®ã¯ä¸è‡ªç„¶ãªæ°—ãŒã—ã¦ã€è‰²ã€…ã¨èª¿ã¹ã¦ã—ã¾ã£ãŸã€‚  

```rb:likes_controller.rb
class LikesController < ApplicationController
  before_action :require_login, only: %i[create destroy]

  ~ çœç•¥ ~

  def destroy
    @post = Post.find(params[:post_id])
    current_user.unlike(@post)
  end
end
```

```slim:_unlike.slim.html
/ _unlike.slim.html

/ like_pathå†…ã«(post_id: post.id)ã‚’è¿½åŠ ã—ãŸã®ãŒå¤‰æ›´ç‚¹
= link_to like_path(current_user.likes.find_by(post_id: post.id), post_id: post.id), method: :delete, remote: true do
  = icon 'fa', 'heart', class: 'fa-lg'
```
